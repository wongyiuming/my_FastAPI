name: Build and Test Docker Compose

on:
  push:
    branches: [ "feat/docker-deploy", "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 0. 关键步骤：创建 .env 文件，防止 Docker Compose 报错
      # 直接将 example 拷贝为 .env 即可满足 Compose 的文件存在性检查
      - name: Create .env file from template
        run: cp .env.example .env

      # 1. 模拟证书环境
      - name: Create Dummy Certificates for Testing
        run: |
          mkdir -p certs
          openssl req -x509 -nodes -days 1 -newkey rsa:2048 \
            -keyout certs/privkey.pem \
            -out certs/fullchain.pem \
            -subj "/C=CN/ST=Default/L=Default/O=Default/CN=localhost"

      # 2. 启动服务
      - name: Build and Start Services
        env:
          # 虽然有了 .env，但这里的 env 优先级更高，会覆盖 .env 中的同名变量
          NGINX_HOST: localhost
          REDIS_URL: redis://redis:6379/0
          WALL_ADMIN_TOKEN: ci_test_token
          WALL_TTL: 240
        run: |
          docker compose up -d --build

      # 3. 等待服务就绪
      - name: Wait for Services
        run: |
          sleep 15
          docker compose ps

      # 4. 验证核心功能
      - name: Test Endpoints
        run: |
          # A. 验证 Swagger (注意：由于 Nginx 配置了跳转，这里需要 -L)
          curl -k -L --fail http://localhost/docs || exit 1
          
          # B. 验证匿名墙静态页面
          curl -k -L --fail http://localhost/wall/index.html || exit 1
          
          # C. 验证匿名墙 API
          # 注意：POST 结果应该包含发送的字符串
          POST_RES=$(curl -k -L -X POST "http://localhost/api/v1/wall/publish?content=CI_Integration_Test")
          echo "Post Result: $POST_RES"
          if [[ "$POST_RES" != *"CI_Integration_Test"* ]]; then
            echo "API Validation Failed: Content not found in response"
            exit 1
          fi

      # 5. 验证 Redis 数据持久化
      - name: Verify Redis Persistence
        run: |
          # 使用服务名 redis 获取容器 ID
          docker exec $(docker compose ps -q redis) redis-cli keys "wall:post:*" | grep "wall:post"

      # 6. 故障排查
      - name: View logs on failure
        if: failure()
        run: |
          docker compose logs nginx
          docker compose logs web
          docker compose logs redis

      # 7. 清理现场
      - name: Stop and Cleanup
        if: always()
        run: |
          docker compose down --volumes --remove-orphans