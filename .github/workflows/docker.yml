name: Build and Test Docker Compose

on:
  push:
    branches: [ "feat/docker-deploy" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 模拟证书环境：CI 环境没有真实证书，必须创建自签名证书骗过 Nginx 启动检查
      - name: Create Dummy Certificates for Testing
        run: |
          mkdir -p certs
          openssl req -x509 -nodes -days 1 -newkey rsa:2048 \
            -keyout certs/privkey.pem \
            -out certs/fullchain.pem \
            -subj "/C=CN/ST=Default/L=Default/O=Default/CN=localhost"

      # 2. 启动服务：注入 NGINX_HOST 变量并启动 compose
      - name: Build and Start Services
        env:
          NGINX_HOST: localhost
        run: |
          # 显式指定环境变量并运行
          docker compose up -d --build

      # 3. 等待服务就绪：Nginx 启动比 FastAPI 快，需要预留渲染和启动时间
      - name: Wait for Services
        run: |
          sleep 10
          docker compose ps

      # 4. 验证 HTTPS 功能
      - name: Test HTTPS Endpoint
        run: |
          # -k 表示忽略自签名证书的警告，-L 跟踪重定向（验证 80 是否跳到 443）
          curl -k -L --fail http://localhost/docs || exit 1

      # 5. 故障排查：如果失败，打印 Nginx 和 FastAPI 日志
      - name: View logs on failure
        if: failure()
        run: |
          docker compose logs nginx
          docker compose logs fastapi_app

      # 6. 清理现场
      - name: Stop and Cleanup
        if: always()
        run: |
          docker compose down --volumes --remove-orphans